name: Build SHFMod DLL

on:
  push:
    tags:
      - 'v*'
  
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    permissions:
      contents: write
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2

    - name: Build Solution
      run: msbuild SHFMod.sln /p:Configuration=Release /p:Platform=x64

    - name: Package Release Files
      id: package_files
      run: |
        Compress-Archive -Path x64/Release/SHFMod.* -DestinationPath SHFMod-${{ github.ref_name }}.zip
        echo "asset_path=SHFMod-${{ github.ref_name }}.zip" >> $env:GITHUB_OUTPUT
      shell: powershell

    - name: Create Release and Upload Files
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        TAG_NAME: ${{ github.ref_name }}
      run: |
        gh release create ${{ env.TAG_NAME }} \
          --title "Release ${{ env.TAG_NAME }}" \
          SHFMod-${{ env.TAG_NAME }}.zip
      shell: bash
